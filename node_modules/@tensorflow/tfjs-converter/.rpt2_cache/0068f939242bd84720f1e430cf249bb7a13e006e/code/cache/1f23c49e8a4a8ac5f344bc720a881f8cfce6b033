{"code":"import * as tslib_1 from \"tslib\";\r\nimport * as tf from '@tensorflow/tfjs';\r\nimport * as Url from 'url';\r\nimport { tensorflow } from '../data/compiled_api';\r\nimport { OperationMapper } from '../operations/operation_mapper';\r\nimport { GraphExecutor } from './graph_executor';\r\nvar FrozenModel = (function () {\r\n    function FrozenModel(modelUrl, weightManifestUrl, requestOption) {\r\n        this.modelUrl = modelUrl;\r\n        this.weightManifestUrl = weightManifestUrl;\r\n        this.requestOption = requestOption;\r\n        this.version = 'n/a';\r\n        this.pathPrefix = this.getPathPrefix();\r\n    }\r\n    Object.defineProperty(FrozenModel.prototype, \"modelVersion\", {\r\n        get: function () {\r\n            return this.version;\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    FrozenModel.prototype.getPathPrefix = function () {\r\n        var url = Url.parse(this.weightManifestUrl);\r\n        var segments = url.pathname.split('/');\r\n        segments.splice(-1);\r\n        url.pathname = segments.join('/');\r\n        return Url.format(url) + '/';\r\n    };\r\n    FrozenModel.prototype.loadRemoteProtoFile = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var response, _a, _b, _c, error_1;\r\n            return tslib_1.__generator(this, function (_d) {\r\n                switch (_d.label) {\r\n                    case 0:\r\n                        _d.trys.push([0, 3, , 4]);\r\n                        return [4, fetch(this.modelUrl, this.requestOption)];\r\n                    case 1:\r\n                        response = _d.sent();\r\n                        _b = (_a = tensorflow.GraphDef).decode;\r\n                        _c = Uint8Array.bind;\r\n                        return [4, response.arrayBuffer()];\r\n                    case 2: return [2, _b.apply(_a, [new (_c.apply(Uint8Array, [void 0, _d.sent()]))()])];\r\n                    case 3:\r\n                        error_1 = _d.sent();\r\n                        throw new Error(this.modelUrl + \" not found. \" + error_1);\r\n                    case 4: return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FrozenModel.prototype.loadWeightManifest = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var manifest, _a, error_2;\r\n            return tslib_1.__generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _b.trys.push([0, 3, , 4]);\r\n                        return [4, fetch(this.weightManifestUrl, this.requestOption)];\r\n                    case 1:\r\n                        manifest = _b.sent();\r\n                        _a = this;\r\n                        return [4, manifest.clone().json()];\r\n                    case 2:\r\n                        _a.weightManifest = _b.sent();\r\n                        return [3, 4];\r\n                    case 3:\r\n                        error_2 = _b.sent();\r\n                        throw new Error(this.weightManifestUrl + \" not found. \" + error_2);\r\n                    case 4: return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FrozenModel.prototype.load = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var graphPromise, manifestPromise, graph, weightMap;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        graphPromise = this.loadRemoteProtoFile();\r\n                        manifestPromise = this.loadWeightManifest();\r\n                        return [4, Promise.all([graphPromise, manifestPromise])];\r\n                    case 1:\r\n                        graph = (_a.sent())[0];\r\n                        this.version = graph.versions.producer + \".\" + graph.versions.minConsumer;\r\n                        return [4, tf.io.loadWeights(this.weightManifest, this.pathPrefix, undefined, this.requestOption)];\r\n                    case 2:\r\n                        weightMap = _a.sent();\r\n                        this.executor =\r\n                            new GraphExecutor(OperationMapper.Instance.transformGraph(graph));\r\n                        this.executor.weightMap = this.convertTensorMapToTensorsMap(weightMap);\r\n                        return [2, true];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FrozenModel.prototype.execute = function (inputs, outputs) {\r\n        if (this.executor.isControlFlowModel) {\r\n            throw new Error('The model contains control flow ops, ' +\r\n                'please use executeAsync method');\r\n        }\r\n        var result = this.executor.execute(this.convertTensorMapToTensorsMap(inputs), outputs);\r\n        var keys = Object.keys(result);\r\n        return (keys.length === 1) ? result[keys[0]] : result;\r\n    };\r\n    FrozenModel.prototype.executeAsync = function (inputs, outputs) {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var result, keys;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this.executor.isControlFlowModel) {\r\n                            throw new Error('The model does not contain control flow ops, ' +\r\n                                'please use execute method for better performance.');\r\n                        }\r\n                        return [4, this.executor.executeAsync(this.convertTensorMapToTensorsMap(inputs), outputs)];\r\n                    case 1:\r\n                        result = _a.sent();\r\n                        keys = Object.keys(result);\r\n                        return [2, (keys.length === 1) ? result[keys[0]] : result];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    FrozenModel.prototype.convertTensorMapToTensorsMap = function (map) {\r\n        return Object.keys(map).reduce(function (newMap, key) {\r\n            newMap[key] = [map[key]];\r\n            return newMap;\r\n        }, {});\r\n    };\r\n    FrozenModel.prototype.dispose = function () {\r\n        this.executor.dispose();\r\n    };\r\n    return FrozenModel;\r\n}());\r\nexport { FrozenModel };\r\nexport function loadFrozenModel(modelUrl, weightsManifestUrl, requestOption) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var model;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    model = new FrozenModel(modelUrl, weightsManifestUrl, requestOption);\r\n                    return [4, model.load()];\r\n                case 1:\r\n                    _a.sent();\r\n                    return [2, model];\r\n            }\r\n        });\r\n    });\r\n}\r\n//# sourceMappingURL=frozen_model.js.map","map":"{\"version\":3,\"file\":\"frozen_model.js\",\"sourceRoot\":\"\",\"sources\":[\"../src/executor/frozen_model.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/usr/local/google/home/piyu/ml/tfjs-converter/executor/frozen_model.d.ts","text":"import * as tf from '@tensorflow/tfjs';\r\nimport { NamedTensorMap } from '../data/types';\r\nexport declare class FrozenModel {\r\n    private modelUrl;\r\n    private weightManifestUrl;\r\n    private requestOption;\r\n    private executor;\r\n    private version;\r\n    private weightManifest;\r\n    private pathPrefix;\r\n    readonly modelVersion: string;\r\n    constructor(modelUrl: string, weightManifestUrl: string, requestOption?: RequestInit);\r\n    getPathPrefix(): string;\r\n    private loadRemoteProtoFile();\r\n    private loadWeightManifest();\r\n    load(): Promise<boolean>;\r\n    execute(inputs: NamedTensorMap, outputs?: string | string[]): tf.Tensor | NamedTensorMap;\r\n    executeAsync(inputs: NamedTensorMap, outputs?: string | string[]): Promise<tf.Tensor | NamedTensorMap>;\r\n    private convertTensorMapToTensorsMap(map);\r\n    dispose(): void;\r\n}\r\nexport declare function loadFrozenModel(modelUrl: string, weightsManifestUrl: string, requestOption?: RequestInit): Promise<FrozenModel>;\r\n"}}
